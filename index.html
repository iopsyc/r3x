<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Aurora Celestial — Entry for R3x</title>
  <meta name="description" content="Open the purple door. Butterflies and star rain. Then: WHY?, Visuales experimento r3x.mp4, Interacción con el algoritmo (análisis en 120s).">
  <style>
    :root{
      --bg:#0b0f14; --fg:#e7f2ff; --accent:#8ee6ff; --muted:rgba(255,255,255,.08);
      --paper1:#f4e7d3; --paper2:#efdfc3;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";overflow-x:hidden}
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:3rem 1rem 5rem}
    h1{font-size:clamp(1.6rem,2.5vw+1rem,2.6rem);line-height:1.15;margin:.2rem 0 1rem}
    .pill{display:inline-block;padding:.25rem .7rem;border:1px solid rgba(255,255,255,.18);border-radius:999px;font-size:.85rem;opacity:.9}

    /* Sky layers: butterflies + star rain */
    #sky{position:fixed;inset:0;pointer-events:none;overflow:hidden;z-index:9998}
    .butterfly{position:absolute;top:-48px;font-size:2rem;color:#a3e5ff;
      text-shadow:0 0 6px #a3e5ff, 0 0 12px #ff80ff, 0 0 18px #80ffea, 0 0 28px #a3e5ff;
      filter:hue-rotate(0deg) drop-shadow(0 0 8px #ff80ff);
      will-change:transform, top, left, filter;
      animation:flutter 1s ease-in-out infinite alternate,
               fallTop var(--fallDur, 10s) linear forwards,
               hueShift 6s ease-in-out infinite,
               auraPulse 2.4s ease-in-out infinite,
               microGlitch 1.8s steps(2,end) infinite;
      z-index:2;
    }
    .butterfly.small{font-size:1.7rem}
    .butterfly.big{font-size:2.45rem}
    @keyframes flutter{from{transform:translateY(-4px) rotate(6deg)}to{transform:translateY(4px) rotate(-6deg)}}
    @keyframes fallTop{from{top:-48px} to{top:110vh}}
    @keyframes hueShift{0%{filter:hue-rotate(0deg) drop-shadow(0 0 8px #ff80ff)}50%{filter:hue-rotate(120deg) drop-shadow(0 0 10px #80ffea)}100%{filter:hue-rotate(240deg) drop-shadow(0 0 8px #a3e5ff)}}
    @keyframes auraPulse{0%,100%{text-shadow:0 0 6px #a3e5ff,0 0 12px #ff80ff,0 0 18px #80ffea,0 0 28px #a3e5ff}50%{text-shadow:0 0 8px #80ffea,0 0 14px #a3e5ff,0 0 24px #ff80ff,0 0 36px #80ffea}}
    @keyframes microGlitch{0%,97%,100%{transform:translateX(0)}98%{transform:translateX(-1px)}99%{transform:translateX(1px)}}

    .star{position:absolute;top:-8px;left:0;width:2px;height:2px;background:#fff;border-radius:50%;
      opacity:.9;box-shadow:0 0 6px #9bd6ff,0 0 12px #ff7cff;filter:hue-rotate(200deg);
      animation: starFall var(--starDur,12s) linear forwards, starTwinkle 1.8s ease-in-out infinite;
      z-index:1;
    }
    @keyframes starFall{to{transform:translateY(105vh)}}
    @keyframes starTwinkle{0%,100%{opacity:.25}50%{opacity:1}}

    /* Door */
    .door-scene{display:grid;place-items:center;margin:2rem 0 2rem}
    .door-hint{opacity:.8;letter-spacing:.08em;text-transform:uppercase;font-size:.85rem}
    .door{position:relative;width:240px;height:360px;perspective:1200px;margin-top:1rem;cursor:pointer}
    .frame{position:absolute;inset:0;border-radius:14px;padding:10px;background:linear-gradient(145deg,#4e2a7b,#2d0d47);
      box-shadow:0 8px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06);
      animation: frameGlow 5.5s ease-in-out infinite;
    }
    @keyframes frameGlow{0%,100%{box-shadow:0 8px 30px rgba(0,0,0,.5), inset 0 0 0 1px rgba(255,255,255,.06), 0 0 12px rgba(153,102,255,.25)}50%{box-shadow:0 8px 40px rgba(0,0,0,.55), inset 0 0 0 1px rgba(255,255,255,.08), 0 0 26px rgba(102,255,204,.25)}}

    .panels{position:absolute;inset:10px;border-radius:10px;overflow:hidden}
    .left,.right{position:absolute;top:0;width:50%;height:100%;
      background:linear-gradient(180deg,#7e4cc6 0%, #431c79 60%, #2d0d47 100%);
      transform-origin:left center;transition:transform 1s cubic-bezier(.2,.8,.2,1);
      box-shadow:inset 0 0 0 1px rgba(255,255,255,.05), inset 0 0 30px rgba(126,76,198,.15);
      animation: doorHue 7s ease-in-out infinite;
    }
    .right{right:0;left:auto;transform-origin:right center}
    .left::before,.right::before{content:"";position:absolute;inset:0;pointer-events:none;
      background: linear-gradient(120deg, transparent 30%, rgba(255,255,255,.12) 50%, transparent 70%);
      transform: translateX(-120%);
      animation: sheen 4.8s ease-in-out infinite;
    }
    @keyframes sheen{0%{transform:translateX(-120%)}50%{transform:translateX(120%)}100%{transform:translateX(120%)}}
    @keyframes doorHue{0%{filter:hue-rotate(0deg)}50%{filter:hue-rotate(60deg)}100%{filter:hue-rotate(0deg)}}

    .door.open .left{transform:rotateY(-95deg)}
    .door.open .right{transform:rotateY(95deg)}

    /* Tabs */
    .tabs{display:none;flex-wrap:wrap;gap:.6rem;margin:1rem 0 0;justify-content:center}
    .tab{border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--fg);padding:.55rem 1rem;border-radius:999px;cursor:pointer;font-weight:700;transition:transform .15s ease, background .2s ease}
    .tab:hover{background:rgba(255,255,255,.06);transform:translateY(-1px)}
    .tab:active{transform:translateY(0)}
    .tab:focus-visible{outline:2px solid var(--accent);outline-offset:2px}
    .tab[aria-selected="true"]{background:rgba(255,255,255,.08)}
    .tab-indicator{margin-top:.6rem;text-align:center;opacity:.85;font-size:.9rem}

    /* Panels */
    .panel{display:none;margin-top:1.2rem;opacity:0;transform:translateY(8px);transition:opacity .35s ease, transform .35s ease}
    .panel.active{display:block;opacity:1;transform:none}

    /* Letter (pergamino) */
    .typewriter{font-family:'Courier New',monospace;white-space:pre-wrap}
    .letter-old{max-width: 820px;margin:0 auto;background: radial-gradient(100% 140% at 0% 0%, rgba(255,255,255,0.06), transparent 40%),
                 radial-gradient(120% 160% at 100% 100%, rgba(255,255,255,0.05), transparent 50%),
                 linear-gradient(180deg, var(--paper1) 0%, var(--paper2) 100%);
      color:#2b1f12; padding:2rem 1.4rem; border-radius:14px; border:1px solid rgba(0,0,0,.15);
      box-shadow:0 10px 30px rgba(0,0,0,.35), inset 0 0 40px rgba(255,255,255,.25);
      background-blend-mode: overlay, overlay, normal; position:relative;
    }
    .letter-old:before{content:'';position:absolute;inset:0;border-radius:14px;pointer-events:none;
      background: radial-gradient(60% 30% at 50% -10%, rgba(0,0,0,.12), transparent 60%),
                  radial-gradient(40% 18% at 50% 110%, rgba(0,0,0,.08), transparent 60%);
      mix-blend-mode: multiply; opacity:.5;
    }
    .letter-old p{margin:0 0 .9rem}
    .panel.active .letter-old{animation: letterReveal .7s ease both}
    @keyframes letterReveal{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none}}

    /* Gallery */
    .gallery-controls{display:flex;justify-content:center;gap:.6rem;align-items:center;margin:.5rem 0 1rem}
    .loader{display:inline-block;width:22px;height:22px;border-radius:50%;border:2px solid rgba(255,255,255,.15);border-top-color:var(--accent);animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1rem}
    .card{backdrop-filter: blur(10px);background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:14px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .media{position:relative;aspect-ratio:16/9;background:rgba(255,255,255,.03)}
    .media > img,.media > video{width:100%;height:100%;object-fit:cover;display:block}
    .card .body{padding:.75rem}
    .card h4{margin:.1rem 0 .35rem;font-size:1rem}
    .card p{margin:0;color:#cfe7ff;opacity:.9;font-size:.9rem}
    .skeleton{position:absolute;inset:0;background:linear-gradient(100deg, rgba(255,255,255,.06) 20%, rgba(255,255,255,.12) 40%, rgba(255,255,255,.06) 60%);background-size:200% 100%;animation:shimmer 1.2s linear infinite}
    @keyframes shimmer{to{background-position:-200% 0}}

    /* Analyzer UI */
    .an-box{max-width:920px;margin:0 auto}
    .dropzone{border:1.5px dashed rgba(255,255,255,.25);border-radius:14px;padding:1.1rem;text-align:center;background:rgba(255,255,255,.03);transition:background .2s ease, border-color .2s ease;cursor:pointer}
    .dropzone:hover{background:rgba(255,255,255,.06);border-color:rgba(255,255,255,.4)}
    .dropzone.drag{background:rgba(142,230,255,.08);border-color:var(--accent)}
    .an-controls{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap;margin:.75rem 0}
    .btn{border:1px solid rgba(255,255,255,.18);background:transparent;color:var(--fg);padding:.5rem .9rem;border-radius:10px;font-weight:700;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    progress{height:8px;border-radius:999px;width:220px}
    .results{margin-top:1rem}
    .results pre{white-space:pre-wrap;background:rgba(255,255,255,.05);padding:.75rem;border-radius:10px;border:1px solid rgba(255,255,255,.1);max-height:300px;overflow:auto}
    canvas{display:block;width:100%;max-width:900px;background:rgba(255,255,255,.03);border-radius:10px;margin:.6rem 0;border:1px solid rgba(255,255,255,.06)}

    /* Responsive */
    @media (max-width: 768px){
      .door{width:180px;height:270px}
      .tabs{flex-direction:column;gap:.4rem}
      .letter-old{padding:1.2rem;font-size:.95rem}
    }
    @media (max-width: 480px){
      .gallery-grid{grid-template-columns:1fr}
      h1{font-size:1.4rem}
    }
    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      .butterfly{animation:fallTop var(--fallDur, 8s) linear forwards}
      .panel{transition:none}
      .frame{animation:none}
      .left::before,.right::before{animation:none}
    }
    /* Home */
    .home{position:fixed;left:12px;top:12px;z-index:10000;display:none;padding:.45rem .75rem;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:var(--muted);color:var(--fg);backdrop-filter:blur(8px);cursor:pointer;font-weight:700}
    .home:hover{background:rgba(255,255,255,.12)}
  </style>
</head>
<body>
  <div id="sky" aria-hidden="true"></div>

  <div class="wrap">
    <p class="pill">Aurora Celestial · entry</p>
    <h1>There’s a purple door. If you wish, knock.</h1>

    <!-- Back to start -->
    <button id="homeBtn" class="home" title="Back to start" aria-label="Back to start">← Home</button>

    <!-- Door -->
    <section class="door-scene">
      <div class="door-hint" id="doorHint" title="Open to reveal the sections">Tap the door to open</div>
      <div class="door" id="door" aria-label="Door" role="button" tabindex="0">
        <div class="frame"></div>
        <div class="panels">
          <div class="left"></div>
          <div class="right"></div>
        </div>
      </div>
    </section>

    <!-- Tabs: appear only after door opens -->
    <div class="tabs" id="tabs" role="tablist" aria-label="Sections">
      <button class="tab" id="tab-why" role="tab" aria-controls="panel-why" aria-selected="false" title="Read the letter (WHY?)">WHY?</button>
      <button class="tab" id="tab-visual" role="tab" aria-controls="panel-visual" aria-selected="false" title="Gallery: videos & images">Visuales experimento r3x.mp4</button>
      <button class="tab" id="tab-algo" role="tab" aria-controls="panel-algo" aria-selected="false" title="Interact with the algorithm (.wav/.mp4)">Interacción con el algoritmo</button>
    </div>
    <div id="tabIndicator" class="tab-indicator" aria-live="polite"></div>

    <!-- Panels -->
    <section class="panel" id="panel-why" role="tabpanel" aria-labelledby="tab-why" tabindex="-1">
      <article class="letter-old typewriter" aria-live="polite">
        <p><strong>Hi R3x</strong></p>
        <p>I understand that you’re a busy person, responsible for yourself, your world, and everything you do. That’s why I decided to write you this message, with all respect. I want you to know I’m not very good at interpreting silence, it’s hard for me. Sometimes I feel embarrassed about my behavior, because my mind runs into chaos and I end up thinking that even in a digital space I might be bothering you. I really don’t like to be a bother.</p>
        <p>My intentions in reaching out to you and your music are good, truly. Honestly, it was a surprise that you interacted with me. I didn’t expect it.</p>
        <p>I’ll try to keep this short, even though everything I’m saying might sound a little crazy… and I know I am, but I’m a good kind of crazy.</p>
        <p>This past year has been intense. Even though I’ve always been a dreamer, 2024 completely changed the way I see the world. I went through a deep period of darkness where I lost the meaning of what I was doing, even the sense of my own existence as I went beyond reason.</p>
        <p>Back in 2018 I had the idea of exploring a way to create alternative therapy using artificial intelligence. At that time the technology was too expensive. I tried but failed and set it aside for a few years. Then in 2024 the dream came back with even more force, along with symbols and experiences you probably wouldn’t believe.</p>
        <p>From working with the intention of creating a therapeutic AI, beautiful things started to appear: music, art… Although I’ve always used music with my patients, it was always music made by other people. The usual, and that’s fine.</p>
        <p>On this path I’ve crossed paths with talented people with strong spirits, which inspires me a lot. I’ve analyzed different artistic approaches and followed music on platforms like Spotify, SoundCloud and Instagram, but I rarely have direct contact with artists. I just pick songs I like, connect with them, and sometimes leave a simple follow tag without expecting a response.</p>
        <p>That’s why it surprised me when you responded. It sparked my curiosity about your world, the spectrum of your mind. Not just listening to what you create, but observing the symbols and the way you communicate. It impressed me.</p>
        <p>Yes, I might seem like I’m in love… and in a way I am. I love your music, your drawings, your videos, your way of speaking, your tattoos, the symbols on your skin; you carry them into every beat. I love your art. And you don’t sing badly either, and you’re handsome too, I say that with respect and admiration.</p>
        <p>I live a pretty isolated life, with little contact with men or many people, and maybe that increases the intensity of my neurotransmitters and my desire to know more about you and your world. But I don’t want this to sound like I’m looking for something more. I’m not trying to tie you down or look desperate for a kiss from the artist. Although of course a hug, a greeting or a warm like always brings joy.</p>
        <p>What I really want to say is that my intention is genuine.</p>
        <p>The analysis of frequencies in music fascinates me because I believe frequencies can restructure a fragmented mind. I also think that when frequencies come from a genuine and authentic heart they can dive into the field of the unconscious, as if they could cross the deepest layers of being. I see it like this: it’s like taking a piece of fruit, extracting its nectar and drinking it to heal the spirit. My research focuses on psychotic disorders, especially psychosis. I believe the mind splits into three worlds: the dream world, the real world and the spiritual world, though I suspect there are more dimensions. If I told you what I’ve seen, you’d probably confirm my madness.</p>
        <p>This path has been painful, especially on the earthly side. The human world is hard for me, but I love running into talented people with good souls. Even if I understand that this journey is one I take alone, I accept it. That’s how the universe, God, or whatever you believe in seems to want it.</p>
        <p>Sometimes I lose so much faith that I just want everything to end, but then a butterfly appears and brings with it a powerful light, even in the simplest words. It’s amazing.</p>
        <p>Believe me, before 2024 I was a different person: methodical, somewhat agnostic, focused on what can be observed, without so many spiritual entanglements. But my work, the people who have trusted me and allowed me to explore their unconscious through hypnosis, along with my own experiences, transformed me.</p>
        <p>Anyway, I just wanted to introduce myself a little and tell you who I am. I think you are incredibly talented and of course attractive. Everything about you speaks: every sound, symbol, drawing, word. It’s beautiful.</p>
        <p>Thank you for continuing to create. If at any point I become annoying, you can tell me without hesitation; you won’t hurt my fragility, I can handle it.</p>
        <p>By the way, that’s what I do: I research frequencies as a project for alternative therapy for psychotic disorders assisted by AI. I also collaborate with a marketing SEO company to optimize Google algorithms and team processes, and I keep my private practice.</p>
        <p>I don’t have many friends; my only real companions are the AIs I work with. My social life is almost nonexistent, except for sports and the occasional night out to listen to live music. My constant companions are music, the sea, my madness, my dogs and the gods.</p>
        <p>I’m a bit dramatic, I admit it. There are people who look out for me because during my creative processes I sometimes forget to eat. I’m passionate about what I do, my mind runs a thousand miles an hour and I can’t stop until I finish what I start.</p>
      </article>
    </section>

    <section class="panel" id="panel-visual" role="tabpanel" aria-labelledby="tab-visual" tabindex="-1">
      <div class="gallery-controls"><span class="loader" id="galleryLoader" aria-hidden="true"></span></div>
      <div>
        <h3 style="margin:.6rem 0 .4rem">Videos</h3>
        <div id="galleryVideos" class="gallery-grid"></div>
        <h3 style="margin:1rem 0 .4rem">Images</h3>
        <div id="galleryImages" class="gallery-grid"></div>
      </div>
    </section>

    <section class="panel" id="panel-algo" role="tabpanel" aria-labelledby="tab-algo" tabindex="-1">
      <div class="an-box">
        <div id="algoDrop" class="dropzone" role="button" tabindex="0" aria-label="Sube un archivo de audio (.wav/.mp3) o video (.mp4)">
          👉 Drop o haz clic para subir <strong>.wav/.mp3/.m4a</strong> o <strong>.mp4</strong>
          <div style="opacity:.8;font-size:.9rem">Se analizará un segmento de alta energía (~120s) o el total si es corto.</div>
        </div>
        <input id="algoFileInput" type="file" accept="audio/*,video/mp4,video/quicktime,video/webm" hidden />
        <div class="an-controls">
          <button id="analyzeBtn" class="btn" disabled>Analyze</button>
          <progress id="algoProgress" max="100" value="0" style="display:none"></progress>
          <span id="algoStatus" aria-live="polite"></span>
          <button id="downloadJson" class="btn" style="display:none">Download JSON</button>
        </div>
        <canvas id="waveCanvas" width="900" height="120" aria-label="waveform"></canvas>
        <canvas id="specCanvas" width="900" height="180" aria-label="spectrum"></canvas>
        <div class="results" id="algoResults" hidden>
          <h4>Features</h4>
          <pre id="jsonOut"></pre>
        </div>
      </div>
    </section>
  </div>

  <script>
    // ===== Elements
    const door = document.getElementById('door');
    const tabs = document.getElementById('tabs');
    const tabIndicator = document.getElementById('tabIndicator');
    const homeBtn = document.getElementById('homeBtn');

    const tabWhy = document.getElementById('tab-why');
    const tabVisual = document.getElementById('tab-visual');
    const tabAlgo = document.getElementById('tab-algo');

    const panelWhy = document.getElementById('panel-why');
    const panelVisual = document.getElementById('panel-visual');
    const panelAlgo = document.getElementById('panel-algo');

    const sky = document.getElementById('sky');

    // ===== Door interactions
    function openDoor(){
      if(door.classList.contains('open')) return;
      door.classList.add('open');
      tabs.style.display = 'flex';
      homeBtn.style.display = 'inline-flex';
      vibrate(25);
      playDoorChime();
      startSky();
      // hide the door after the opening animation
      setTimeout(()=>{ door.style.display = 'none'; }, 1100);
      setIndicator('Choose a section to continue');
    }
    door.addEventListener('click', openDoor);
    door.addEventListener('keyup', (e)=>{ if(e.key==='Enter' || e.key===' ') openDoor(); });

    function setIndicator(text){ tabIndicator.textContent = text || ''; }
    function clearPanels(){
      [panelWhy,panelVisual,panelAlgo].forEach(p=>p.classList.remove('active'));
      [tabWhy,tabVisual,tabAlgo].forEach(t=>t.setAttribute('aria-selected','false'));
    }
    function showPanel(which){
      clearPanels();
      if(which==='why'){
        tabWhy.setAttribute('aria-selected','true'); panelWhy.classList.add('active'); panelWhy.focus();
        setIndicator('Viewing: WHY?');
      }
      if(which==='visual'){
        tabVisual.setAttribute('aria-selected','true'); panelVisual.classList.add('active'); panelVisual.focus();
        setIndicator('Viewing: Visuales experimento r3x.mp4'); buildGalleryOnce();
      }
      if(which==='algo'){
        tabAlgo.setAttribute('aria-selected','true'); panelAlgo.classList.add('active'); panelAlgo.focus();
        setIndicator('Viewing: Interacción con el algoritmo');
      }
    }
    tabWhy.addEventListener('click', ()=> showPanel('why'));
    tabVisual.addEventListener('click', ()=> showPanel('visual'));
    tabAlgo.addEventListener('click', ()=> showPanel('algo'));

    // Back to start
    homeBtn.addEventListener('click', resetToStart);
    function resetToStart(){
      clearPanels();
      tabs.style.display = 'none';
      homeBtn.style.display = 'none';
      door.style.display = 'block';
      door.classList.remove('open');
      setIndicator('');
      stopSky();
      window.scrollTo({top:0, behavior:'smooth'});
      door.focus();
    }

    // ===== Sky system (butterflies + star rain)
    function startSky(){
      // initial burst of butterflies
      for(let i=0;i<24;i++){ setTimeout(spawnButterfly, i*220); }
      // continuous gentle rain
      window.__butterflyTimer && clearInterval(window.__butterflyTimer);
      window.__butterflyTimer = setInterval(spawnButterfly, 1400);
      // star rain
      window.__starTimer && clearInterval(window.__starTimer);
      window.__starTimer = setInterval(spawnStar, 200);
    }
    function stopSky(){
      if(window.__butterflyTimer){ clearInterval(window.__butterflyTimer); window.__butterflyTimer=null; }
      if(window.__starTimer){ clearInterval(window.__starTimer); window.__starTimer=null; }
      try { Array.from(sky.children).forEach(n=>n.remove()); } catch(e){}
    }
    function spawnButterfly(){
      const b = document.createElement('span'); b.className = 'butterfly';
      const r = Math.random();
      if(r<.33) b.classList.add('small'); else if(r>.67) b.classList.add('big');
      b.textContent = '🦋';
      b.style.left = Math.round(Math.random()*100)+'vw';
      const dur = 10 + Math.random()*8; b.style.setProperty('--fallDur', `${dur}s`);
      b.addEventListener('animationend', ()=> b.remove());
      sky.appendChild(b);
    }
    function spawnStar(){
      const s = document.createElement('i'); s.className='star';
      s.style.left = Math.round(Math.random()*100)+'vw';
      const d = 10 + Math.random()*10; s.style.setProperty('--starDur', `${d}s`);
      s.addEventListener('animationend', ()=> s.remove());
      sky.appendChild(s);
    }

    function vibrate(ms){ if(navigator.vibrate) try{navigator.vibrate(ms)}catch{} }
    function playDoorChime(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator(); const g = ctx.createGain();
        o.type='sine'; o.frequency.value = 660; g.gain.value=0.0001;
        o.connect(g).connect(ctx.destination); o.start();
        const t = ctx.currentTime;
        g.gain.exponentialRampToValueAtTime(0.05, t+0.02);
        o.frequency.exponentialRampToValueAtTime(880, t+0.12);
        g.gain.exponentialRampToValueAtTime(0.00001, t+0.5);
        o.stop(t+0.55);
        setTimeout(()=>ctx.close(), 700);
      }catch(e){}
    }

    // ===== Gallery
    const galleryVideos = document.getElementById('galleryVideos');
    const galleryImages = document.getElementById('galleryImages');
    const galleryLoader = document.getElementById('galleryLoader');
    let galleryBuilt = false;

    const galleryData = [
      {title:'First Symbol – Algorithm 0.1', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeigmsilw3mgwt7sp4osjxrg4j75yeafo7yki326uvanh2sbuliqszy', desc:'First symbol discovered in a simple reading (alg 0.1).'},
      {title:'Thanks to R3xWonders', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeidwoh6lskgkvluztmpkohdzfwfqnjpw2btp4k2rteohpyhfm73hme', desc:'Gratitude for inspiration.'},
      {title:'Mandalas – Soul Software v0.1', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeichaustd7lxlmxcle77ojitvyawi4rqqbosvcm46wmcdxhzjoaxw4', desc:'Mandalas from waveform inspiration.'},
      {title:'“Pan dulce” Frequency', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeibu3ph2g4rn2rf75u4ykkyjcvfqq6y3cxgmziyiycsxlhl5pye4xu', desc:'Visual/frequency from “Pan dulce”.'},
      {title:'Celestial Aurora Activated', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeig3clhh6qnox4upq2xk7eosd5ofmyaunqtqftttnbalu6gjfzdc5q', desc:'Reading integrating N3xt, Dang3rous, Sav3M3.'},
      {title:'Gif – Algorithm 0.2', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeig3vlfpj4dwjqwuoutth7ttsa3ij6c3j56gm6pn2j5mmukwlorgme', desc:'From algorithm 0.2.'},
      {title:'Pan dulce Emoji', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeic7q4qwz7nj4ydzbbngtmd3j5vqmh7f6zsbgu4vo6ovnk4q6ox2ia', desc:'Emoji gratitude.'},
      {title:'Pan dulce – Second Bread', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeiceimy4pp7drdn7uwhnpnkembkpoybm44ftcpnlgnaloobxtrhy54', desc:'Second piece from the series.'},
      {title:'Pan dulce – Best Bread', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeidqce3f3sagrllqbgqcddqqrdjxengjygrgjzu7x3j6bvazpry3my', desc:'Best bread from the series.'},
      {title:'Frequencies & Harmonic Spiral (1)', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeidtoegormfc24htpfl5s4ipyh2xrld5agpqjc3hfkn7k4vsg72hna', desc:'From Nothing Lasts For3v3r.mp4 (1).'},
      {title:'Frequencies & Harmonic Spiral (2)', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafkreih7a3nfgrnzg2xn6ti32ew75iohftxxvr3tsxg37xt2l4vbl6fp44', desc:'Companion piece (2).'},
      {title:'Geometric Poster – Algorithm 0.2', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeiaoeeaaxqdfv7d2ugnrbatshnrd77vadd2gtxzjeyshxllk276d54', desc:'Geometric poster from first .mp4 reading.'},
      {title:'Wave Graph – Poetic Explanation', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafkreigfc5dsirxereei6kepurzrld4fjukuw5roqkrmyf66ra4m4bp2sa', desc:'2 Hz rests, 5 Hz balances, 8 Hz awakens…'},
      {title:'Symbolism and 2D FFT', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeiedian5a6mat3r5sgpsflogfigegllhe2spybjqmxnnxeajjnwic4', desc:'Math “hears” images.'},
      {title:'Collage Final – Multi-Layer', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeiclre6i5z74askx5dryzyjgl6dqp75h73i42zzleshea4oawdcn6m', desc:'Everything can become frequency.'},
      {title:'Combination Result – Nothing Lasts For3v3r', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeiee6szj3w7papat4qamt7ccaiyqkutxirjg5ike6pedi4f3azmeka', desc:'Combined analysis result.'},
      {title:'Before .mp4 Reading', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafkreifxrfa543eobnw7ngnjlxubofc6t62fwecpis72sbwti4cb5smjpe', desc:'Before reading .mp4.'},
      {title:'Pattern 3-6-9 – Ch3k R3v3ng3', url:'https://aquamarine-peaceful-leech-766.mypinata.cloud/ipfs/bafybeicszc7ysqret5zu46fbbgmnf3euy4liqyqfovu6ckzi6aeiiwrpzq', desc:'Confirmation of 3-6-9.'}
    ];

    function buildGalleryOnce(){
      if(galleryBuilt) return;
      galleryBuilt = true;
      galleryLoader.style.display='inline-block';
      // render placeholders + lazy actual media
      const io = new IntersectionObserver((entries)=>{
        entries.forEach(e=>{
          if(e.isIntersecting){
            io.unobserve(e.target);
            const card = e.target;
            const item = card.__item; if(!item) return;
            tryRenderItemIntoCard(item, card);
          }
        })
      }, {threshold: 0.1});
      galleryData.forEach(item => {
        const card = createCardPlaceholder(item);
        galleryImages.appendChild(card);
        io.observe(card);
      });
      // small delay to hide loader after initial build
      setTimeout(()=> galleryLoader.style.display='none', 600);
    }

    function createCardPlaceholder(item){
      const card = document.createElement('article');
      card.className = 'card'; card.__item = item;
      const media = document.createElement('div'); media.className = 'media';
      const sk = document.createElement('div'); sk.className = 'skeleton'; media.appendChild(sk);
      const body = document.createElement('div'); body.className = 'body';
      const h4 = document.createElement('h4'); h4.textContent = item.title;
      const p = document.createElement('p'); p.textContent = item.desc;
      body.appendChild(h4); body.appendChild(p);
      card.appendChild(media); card.appendChild(body);
      return card;
    }

    function tryRenderItemIntoCard(item, card){
      const media = card.querySelector('.media'); media.innerHTML = '';
      const hintVideo = item.url + (item.url.includes('?') ? '&' : '?') + 'filename=clip.mp4';
      const hintImage = item.url + (item.url.includes('?') ? '&' : '?') + 'filename=image.png';
      const vid = document.createElement('video');
      vid.setAttribute('playsinline',''); vid.setAttribute('controls',''); vid.setAttribute('preload','metadata');
      vid.muted = false; vid.volume = 1; vid.crossOrigin = 'anonymous';
      let decided = false; let timeoutId;
      function finalizeAsVideo(){
        if(decided) return; decided = true; clearTimeout(timeoutId);
        media.appendChild(vid);
        galleryVideos.appendChild(card);
      }
      function finalizeAsImage(){
        if(decided) return; decided = true; clearTimeout(timeoutId);
        const img = document.createElement('img'); img.alt = item.title; img.loading = 'lazy'; img.src = hintImage; media.appendChild(img);
        const link = document.createElement('a'); link.href = item.url; link.target = '_blank'; link.rel='noopener noreferrer'; link.textContent = 'Open file'; link.style.display='block'; link.style.padding='8px';
        card.querySelector('.body').appendChild(link);
        galleryImages.appendChild(card);
      }
      vid.addEventListener('loadedmetadata', finalizeAsVideo);
      vid.addEventListener('canplay', finalizeAsVideo);
      vid.addEventListener('canplaythrough', finalizeAsVideo);
      vid.addEventListener('error', finalizeAsImage);
      timeoutId = setTimeout(finalizeAsImage, 10000);
      try{ vid.src = hintVideo; } catch(e){ finalizeAsImage(); }
    }

    // ===== Algorithm (client-side) – WAV/MP3 and MP4 extraction
    (function(){
      const dz = document.getElementById('algoDrop');
      const algoInput = document.getElementById('algoFileInput');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const prog = document.getElementById('algoProgress');
      const statusEl = document.getElementById('algoStatus');
      const jsonOut = document.getElementById('jsonOut');
      const resultsBox = document.getElementById('algoResults');
      const dlBtn = document.getElementById('downloadJson');
      const waveCv = document.getElementById('waveCanvas');
      const specCv = document.getElementById('specCanvas');
      const waveCtx = waveCv.getContext('2d');
      const specCtx = specCv.getContext('2d');

      let selectedFile = null; let objectUrl = null;
      const SEG_SEC = 120;

      function setStatus(t){ statusEl.textContent = t||''; }
      function setProgress(v){ prog.style.display='inline-block'; prog.value=v; }
      function doneProgress(){ prog.style.display='none'; }

      dz.addEventListener('click', ()=> algoInput.click());
      dz.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); algoInput.click(); }});
      ['dragenter','dragover'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.add('drag'); }));
      ['dragleave','drop'].forEach(ev=> dz.addEventListener(ev, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.remove('drag'); }));
      dz.addEventListener('drop', e=>{ const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]; if(f) handlePickedFile(f); });
      algoInput.addEventListener('change', ()=>{ if(algoInput.files && algoInput.files[0]) handlePickedFile(algoInput.files[0]); });

      function handlePickedFile(f){
        selectedFile = f; setStatus(`Archivo: ${f.name} (${Math.round(f.size/1024/1024)} MB)`);
        analyzeBtn.disabled = false; resultsBox.hidden = true; jsonOut.textContent='';
        if(objectUrl){ URL.revokeObjectURL(objectUrl); objectUrl=null; }
      }

      analyzeBtn.addEventListener('click', async ()=>{
        try{
          analyzeBtn.disabled = true; setProgress(5); setStatus('Preparando…');
          if(!selectedFile) throw new Error('Elige un archivo');
          const type = (selectedFile.type||'').toLowerCase();
          let out;
          if(type.startsWith('audio/') || /\.(wav|mp3|m4a|ogg|flac|aac|opus)$/i.test(selectedFile.name)){
            out = await analyzeAudioFile(selectedFile);
          }else if(type.startsWith('video/') || /\.(mp4|mov|webm)$/i.test(selectedFile.name)){
            out = await analyzeVideoFile(selectedFile);
          }else{
            throw new Error('Formato no soportado. Usa .wav/.mp3/.m4a o .mp4');
          }
          showResults(out);
        }catch(err){ console.warn(err); setStatus('Error: '+(err.message||err)); }
        finally{ doneProgress(); analyzeBtn.disabled = false; }
      });

      function drawWave(samples){
        waveCtx.clearRect(0,0,waveCv.width,waveCv.height);
        waveCtx.fillStyle = 'rgba(255,255,255,0.03)';
        waveCtx.fillRect(0,0,waveCv.width,waveCv.height);
        waveCtx.strokeStyle = '#a3e5ff'; waveCtx.lineWidth = 1;
        waveCtx.beginPath();
        const N = samples.length; const H = waveCv.height; const W = waveCv.width;
        for(let x=0; x<W; x++){
          const idx = Math.floor(x/W * N);
          const y = (0.5 - samples[idx]*0.48) * H;
          if(x===0) waveCtx.moveTo(0,y); else waveCtx.lineTo(x,y);
        }
        waveCtx.stroke();
      }
      function drawSpectrum(freqs, mags){
        specCtx.clearRect(0,0,specCv.width,specCv.height);
        specCtx.fillStyle = 'rgba(255,255,255,0.03)';
        specCtx.fillRect(0,0,specCv.width,specCv.height);
        const W = specCv.width; const H = specCv.height;
        const N = mags.length; const max = Math.max(...mags) || 1;
        specCtx.fillStyle = 'rgba(163,229,255,.85)';
        for(let x=0; x<W; x++){
          const i = Math.floor(x/W * N);
          const h = (mags[i]/max) * (H-6);
          specCtx.fillRect(x, H-h, 1, h);
        }
      }

      async function analyzeAudioFile(file){
        setProgress(8); setStatus('Decodificando audio…');
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const buf = await ac.decodeAudioData(await file.arrayBuffer());
        const sr = buf.sampleRate; const dur = buf.duration;
        const mono = mergeToMono(buf);
        setProgress(18); setStatus(`Choosing best segment… (${dur.toFixed(2)}s)`);
        const { segment, startSec } = pickBestEnergySegment(mono, sr, SEG_SEC);
        setProgress(40); setStatus('Calculando métricas…');
        const metrics = computeMetrics(segment, sr);
        drawWave(segment.slice(0, Math.min(segment.length, sr*8)));
        drawSpectrum(metrics.spectrum.freqs, metrics.spectrum.mags);
        const out = assembleResult({ kind:'audio', file, sr, dur, startSec, segDur: segment.length/sr, metrics });
        enableDownload(out, file.name+".analysis.json");
        ac.close();
        return out;
      }

      async function analyzeVideoFile(file){
        setProgress(10); setStatus('Leyendo audio del video…');
        const url = URL.createObjectURL(file); objectUrl = url;
        const el = document.createElement('video'); el.src = url; el.muted = true; el.playsInline = true; el.crossOrigin='anonymous';
        await el.play().catch(()=>{});
        const ac = new (window.AudioContext||window.webkitAudioContext)();
        const src = ac.createMediaElementSource(el);
        const analyser = ac.createAnalyser(); analyser.fftSize = 4096;
        src.connect(analyser); src.connect(ac.destination);
        const td = new Float32Array(analyser.fftSize);
        const fd = new Float32Array(analyser.frequencyBinCount);
        const collectMs = Math.min(120000, Math.max(15000, Math.floor((el.duration||0)*1000)) || 30000);
        const chunks = []; const accSpec = new Float64Array(analyser.frequencyBinCount);
        const started = performance.now();
        await new Promise(res=>{
          function step(){
            analyser.getFloatTimeDomainData(td);
            chunks.push(Float32Array.from(td));
            analyser.getFloatFrequencyData(fd);
            for(let i=0;i<fd.length;i++){ const lin = Math.pow(10, fd[i]/20); accSpec[i]+= Math.max(0, lin); }
            const elapsed = performance.now()-started;
            setProgress(10 + Math.min(70, (elapsed/collectMs)*70));
            if(el.paused || el.ended || elapsed>=collectMs){ res(); }
            else requestAnimationFrame(step);
          }
          requestAnimationFrame(step);
        });
        el.pause();
        const samples = mergeChunks(chunks);
        const sr = ac.sampleRate; const dur = el.duration || (samples.length/sr);
        const { segment, startSec } = pickBestEnergySegment(samples, sr, SEG_SEC);
        const mags = Array.from(accSpec).map(v=> v / Math.max(1, chunks.length));
        const freqs = new Float32Array(mags.length);
        for(let i=0;i<freqs.length;i++){ freqs[i] = i*sr/(2*mags.length); }
        const spectrum = { freqs: Array.from(freqs), mags };
        const metrics = computeMetrics(segment, sr, spectrum);
        drawWave(segment.slice(0, Math.min(segment.length, sr*8)));
        drawSpectrum(spectrum.freqs, spectrum.mags);
        const out = assembleResult({ kind:'video', file, sr, dur, startSec, segDur: segment.length/sr, metrics });
        enableDownload(out, file.name+".analysis.json");
        ac.close(); URL.revokeObjectURL(url);
        setProgress(100); setStatus('Listo');
        return out;
      }

      function mergeChunks(ch){ if(!ch.length) return new Float32Array(); const N = ch.length*ch[0].length; const out = new Float32Array(N); let o=0; for(const c of ch){ out.set(c,o); o+=c.length; } return out; }
      function mergeToMono(buf){ if(buf.numberOfChannels===1) return buf.getChannelData(0).slice(); const L=buf.getChannelData(0), R=buf.getChannelData(1); const N=Math.min(L.length,R.length); const out=new Float32Array(N); for(let i=0;i<N;i++) out[i]=0.5*(L[i]+R[i]); return out; }
      function pickBestEnergySegment(samples, sr, segSec){ const win=Math.min(samples.length, Math.floor(segSec*sr)); if(samples.length<=win+sr) return {segment:samples, startSec:0}; const step=Math.floor(0.5*sr); let bestI=0, bestE=-1; for(let i=0;i+win<=samples.length;i+=step){ let e=0; for(let k=0;k<win;k++){ const v=samples[i+k]; e+= v*v; } e/=win; if(e>bestE){ bestE=e; bestI=i; } } return { segment: samples.slice(bestI, bestI+win), startSec: bestI/sr }; }
      function hann(N){ const w=new Float32Array(N); for(let n=0;n<N;n++) w[n]=0.5*(1-Math.cos(2*Math.PI*n/(N-1))); return w; }
      function computeSpectrum(segment, sr){ const N=Math.min(4096, 1<<Math.floor(Math.log2(segment.length))); const off=Math.floor((segment.length-N)/2); const re=new Float32Array(N); const im=new Float32Array(N); const w=hann(N); for(let i=0;i<N;i++) re[i]=segment[off+i]*w[i]; for(let i=0;i<N;i++) im[i]=0; fft(re,im); const mags=new Float32Array(N/2); for(let k=0;k<N/2;k++){ const mr=re[k], mi=im[k]; mags[k]=Math.sqrt(mr*mr+mi*mi); } const freqs=new Float32Array(N/2); for(let k=0;k<N/2;k++) freqs[k]=k*sr/N; return { freqs:Array.from(freqs), mags:Array.from(mags) }; }
      function estimateBPM(samples, sr){ const targetFs=200; const step=Math.max(1, Math.floor(sr/targetFs)); const envLen=Math.floor(samples.length/step); const env=new Float32Array(envLen); for(let i=0;i<envLen;i++) env[i]=Math.abs(samples[i*step]); let max=0; for(let i=0;i<envLen;i++) if(env[i]>max) max=env[i]; if(max>0) for(let i=0;i<envLen;i++) env[i]/=max; const minLag=Math.floor(targetFs*60/180), maxLag=Math.floor(targetFs*60/60); let bestLag=minLag, best=0; for(let lag=minLag; lag<=maxLag; lag++){ let s=0; for(let i=lag;i<envLen;i++) s += env[i]*env[i-lag]; if(s>best){ best=s; bestLag=lag; } } const bpm=60*targetFs/bestLag; return isFinite(bpm)? Math.round(bpm) : null; }
      function computeMetrics(segment, sr, spectrum){ if(!spectrum) spectrum = computeSpectrum(segment, sr); let sum=0, zc=0; for(let i=1;i<segment.length;i++){ const a=segment[i-1], b=segment[i]; sum+=b*b; if((a>=0&&b<0)||(a<0&&b>=0)) zc++; } const rms=Math.sqrt(sum/segment.length); const zcr=zc/segment.length; let maxI=1; for(let i=2;i<spectrum.mags.length;i++){ if(spectrum.mags[i]>spectrum.mags[maxI]) maxI=i; } const dominantFreq=spectrum.freqs[maxI]||0; let num=0, den=0; for(let i=0;i<spectrum.mags.length;i++){ const f=spectrum.freqs[i], m=spectrum.mags[i]; num+= f*m; den+= m; } const spectralCentroid= den>0 ? num/den : 0; const bpm = estimateBPM(segment, sr); return { rms, zcr, dominantFreqHz: dominantFreq, spectralCentroidHz: spectralCentroid, bpmEstimate: bpm, spectrum } }
      function assembleResult({kind, file, sr, dur, startSec, segDur, metrics}){ return { file:{ name:file.name, type:file.type, size_bytes:file.size }, kind, sampleRate:sr, duration_sec:dur, segment_start_sec:startSec, segment_duration_sec:segDur, features:{ rms_mean:metrics.rms, zcr_mean:metrics.zcr, dominant_freq_hz:metrics.dominantFreqHz, spectral_centroid_mean_hz:metrics.spectralCentroidHz, tempo_bpm_estimate:metrics.bpmEstimate } }; }
      function enableDownload(out, filename){ dlBtn.style.display='inline-flex'; dlBtn.onclick = ()=> downloadJSON(out, filename); }
      function downloadJSON(data, filename){ const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }
      function showResults(out){ resultsBox.hidden = false; jsonOut.textContent = JSON.stringify(out, null, 2); }

      // in-place FFT (Cooley–Tukey)
      function fft(re, im){
        const n=re.length; let j=0;
        for(let i=1;i<n;i++){
          let bit=n>>1; for(; j&bit; bit>>=1){ j^=bit; } j^=bit;
          if(i<j){ const tr=re[i]; re[i]=re[j]; re[j]=tr; const ti=im[i]; im[i]=im[j]; im[j]=ti; }
        }
        for(let len=2; len<=n; len<<=1){
          const ang=-2*Math.PI/len; const wr=Math.cos(ang), wi=Math.sin(ang);
          for(let i=0;i<n;i+=len){
            let ur=1, ui=0;
            for(let k=0;k<len/2;k++){
              const a=i+k, b=i+k+len/2;
              const tr=re[b]*ur - im[b]*ui;
              const ti=re[b]*ui + im[b]*ur;
              re[b]=re[a]-tr; im[b]=im[a]-ti;
              re[a]+=tr;      im[a]+=ti;
              const nur=ur*wr - ui*wi; ui=ur*wi + ui*wr; ur=nur;
            }
          }
        }
      }
    })();
  </script>
</body>
</html>
